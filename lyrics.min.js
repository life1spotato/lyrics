let player,lyrics=[],currentLyricIndex=-1,offset=0,musicMode="MR",presets={},mrOffset=0,arOffset=0,webFonts={},currentFont="",currentWeight=400,currentSize=32;const brDefault=0;let musicOptions=[];const tag=document.createElement("script");function onYouTubeIframeAPIReady(){}function loadWebFonts(e){webFonts={};const t=document.getElementById("custom-fonts")||document.createElement("style");t.id="custom-fonts",t.innerHTML="";for(const n in e){const i=e[n],s=`\n      @font-face {\n        font-family: '${i.name}';\n        src: ${i.url?`url('${i.url}') format('${i.format||"woff2"}')`:'local("Arial")'};\n        font-weight: ${i.weight||"normal"};\n        font-style: ${i.style||"normal"};\n        font-display: swap;\n      }\n    `;t.innerHTML+=s,webFonts[n]=i}document.getElementById("custom-fonts")||document.head.appendChild(t)}function applyInlineTags(e,t=!1){return e=(e=(e=(e=(e=(e=e.replace(/\[font\]/g,(()=>t?(t&&(e=e.split("[p]")[0]),currentFont="",'</span><span style="font-family: inherit">'):""))).replace(/\[font(\d*)\]/g,((e,n)=>{if(!t)return"";if(!n)return currentFont="",'</span><span style="font-family: inherit">';const i=`font${n}`;return webFonts[i]?(currentFont=webFonts[i].name,`<span style="font-family: '${currentFont}', sans-serif">`):""}))).replace(/\[weight=(\d+)\]/g,((e,n)=>t?(currentWeight=n,`<span style="font-weight: ${n}">`):""))).replace(/\[size=(\d+)\]/g,((e,n)=>t?(currentSize=parseInt(n),`<span style="font-size: ${currentSize}px">`):""))).replace(/\[br(?::([-\d]+))?(?:=([-\d]+))?\]/g,((e,t,n)=>{const i=void 0!==n?parseInt(n):void 0!==t?parseInt(t):brDefault;return i>=0?`</div><div class="br-spacer br-positive" style="--spacing: ${i}px"></div><div>`:`</div><div class="br-spacer br-negative" style="--spacing: ${i}px"></div><div>`}))).replace(/\[\/(size|font)\]/g,t?"</span>":"")}function loadVideo(e){let t;if(e)t=e.split("v=")[1]?.split("&")[0];else{const e=document.getElementById("youtubeUrl").value;t=e.split("v=")[1]?.split("&")[0]}t?player?(player.loadVideoById({videoId:t,startSeconds:0,endSeconds:0,suggestedQuality:"default"}),player.pauseVideo()):player=new YT.Player("player",{width:"480",height:"270",videoId:t,playerVars:{autoplay:0,controls:1,rel:0},events:{onReady:()=>{setInterval(updateLyrics,100)}}}):alert("유효한 YouTube URL을 입력해주세요.")}function handleLyricFile(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{const t=parseLyrics(e.target.result);lyrics=t,currentLyricIndex=-1,createMusicOptions(),musicOptions.length>0&&(loadVideo(musicOptions[0].url),offset=musicOptions[0].offset,document.getElementById("offsetDisplay").innerText=`${offset.toFixed(2)}초`)},n.readAsText(t)}function parseLyrics(e){const t=e.split("\n"),n=[];musicOptions=[];let i={};currentFont="",currentWeight=400,currentSize=32;for(let e of t){const t=e.match(/\[(font\d+)(?:-(\w+))?:([^\]]+)\]/);if(t){const[e,n,s,r]=t;s?(i[n]||(i[n]={}),i[n][s]="weight"===s?parseInt(r):r):i[n]={name:r}}}Object.keys(i).length>0&&loadWebFonts(i);const s=e.match(/\[mr-offset:([-\d.]+)\]/),r=e.match(/\[ar-offset:([-\d.]+)\]/);s&&(mrOffset=parseFloat(s[1])),r&&(arOffset=parseFloat(r[1]));for(let e of t){const t=e.split(/\[preset:(\d+)\]/).slice(1);for(let e=0;e<t.length;e+=2){const n=t[e],i=t[e+1]||"",s=i.search(/\[preset:(\d+)\]/),r=-1!==s?i.slice(0,s):i;presets[n]=r.trim()}}const o=/\[(music\d+):([^\]]+)\]/g,l=/\[(music\d+-url):([^\]]+)\]/,c=/\[(music\d+-offset):([-\d.]+)\]/;t.forEach((e=>{const t=e.match(o);if(t){const[e,n,i]=t[0].match(/\[(music\d+):([^\]]+)\]/);musicOptions.push({id:n,name:i,url:"",offset:0})}const n=e.match(l);if(n&&musicOptions.length>0){const e=n[1].split("-")[0],t=musicOptions.find((t=>t.id===e));t&&(t.url=n[2])}const i=e.match(c);if(i&&musicOptions.length>0){const e=i[1].split("-")[0],t=musicOptions.find((t=>t.id===e));t&&(t.offset=parseFloat(i[2]))}}));for(let e of t){const t=e.match(/\[(\d{2}):(\d{2})\.(\d{2})\](.*)/);if(t){const e=60*parseInt(t[1])+parseInt(t[2])+parseInt(t[3])/100;let i=t[4];i=i.replace(/\[preset=(\d+)\]/g,((e,t)=>presets[t]||""));const s=i.split("[p]"),r=s[0],o=s.length>1?s.slice(1).join("[p]"):null;n.push({time:e,text:i,beforeP:r,afterP:o,hasP:s.length>1,font:currentFont,weight:currentWeight,size:currentSize})}}return n.sort(((e,t)=>e.time-t.time)),n.modeUrls={mr:null,ar:null},n.musicOptions=musicOptions,n}function createMusicOptions(){const e=document.querySelector(".control-group:last-child");if(e.innerHTML="",0===musicOptions.length)return;const t=document.createElement("div");t.className="radio-group";const n=document.createElement("label");n.textContent="음악:",t.appendChild(n),musicOptions.forEach(((e,n)=>{const i=`music-option-${n}`,s=document.createElement("div");s.className="radio-option";const r=document.createElement("input");r.type="radio",r.id=i,r.name="music-mode",r.value=e.id,0===n&&(r.checked=!0);const o=document.createElement("label");o.htmlFor=i,o.textContent=e.name,s.appendChild(r),s.appendChild(o),t.appendChild(s)})),e.appendChild(t)}function applyAlignment(e){document.getElementById("lyrics-view").style.textAlign=e}function applyPreviewAlignment(e){document.getElementById("lyrics-preview").style.textAlign=e}function changeAlignment(){applyAlignment(document.querySelector('input[name="alignment"]:checked').value)}function getMusicModeUrl(){if(!lyrics.modeUrls)return null;switch(musicMode){case"MR":default:return lyrics.modeUrls.mr;case"AR":return lyrics.modeUrls.ar||lyrics.modeUrls.mr}}function adjustOffset(e){offset+=e,document.getElementById("offsetDisplay").innerText=`${offset.toFixed(2)}초`}function resetOffset(){offset=0,document.getElementById("offsetDisplay").innerText="0.00초"}function updateLyrics(){if(!player||!lyrics.length)return;const e=player.getCurrentTime()+offset;let t=-1;for(let n=0;n<lyrics.length;n++)if(e<lyrics[n].time){t=n-1;break}if(-1===t&&lyrics.length>0&&(t=lyrics.length-1),t!==currentLyricIndex){currentLyricIndex=t;const e=lyrics[t]||null;updateLyricsView(e),setTimeout((()=>{updateLyricsPreview(e,t)}),300)}}function updateLyricsView(e){const t=document.getElementById("lyrics-view");t.querySelectorAll(".lyric-line").forEach((e=>{e.classList.add("exiting"),e.style.transition="opacity 0.5s ease-out, transform 0.5s ease-out"})),setTimeout((()=>{if(t.innerHTML="",e){const n=document.createElement("div");n.className="lyric-line entering",n.style.fontSize=`${e.size||32}px`,n.innerHTML=applyInlineTags(e.hasP?e.beforeP:e.text,!0),t.appendChild(n),n.offsetHeight,n.classList.add("active"),n.classList.remove("entering")}}),500)}function updateLyricsPreview(e,t){const n=document.getElementById("preview-past"),i=document.getElementById("preview-current"),s=document.getElementById("preview-future");if(t>0){const e=lyrics[t-1];n.innerHTML=applyInlineTags(e.hasP?e.afterP||"":e.text,!1)}else n.innerHTML="";if(e){const t=e.hasP?e.afterP||"":e.text;i.innerHTML=`\n  <div style="font-weight: ${e.weight};\n              font-size: ${e.size||32}px;">\n    ${applyInlineTags(t,!1)}\n  </div>`}else i.innerHTML="가사 없음";if(t<lyrics.length-1){const e=lyrics[t+1];s.innerHTML=applyInlineTags(e.hasP?e.afterP||"":e.text,!1)}else s.innerHTML=""}tag.src="https://www.youtube.com/iframe_api",document.body.appendChild(tag),document.addEventListener("DOMContentLoaded",(()=>{document.getElementById("lyricFile").addEventListener("change",handleLyricFile),document.getElementById("lyricFile").addEventListener("change",(function(e){e.target.files.length>0&&handleLyricFile(e)})),document.getElementById("openButton").addEventListener("click",(function(){const e=document.getElementById("lyricFile");if(0===e.files.length)return;const t=e.files[0];e.value="",setTimeout((()=>{const n=new DataTransfer;n.items.add(t),e.files=n.files,e.dispatchEvent(new Event("change"))}),300)})),document.querySelectorAll('input[name="alignment"]').forEach((e=>{e.addEventListener("change",(e=>{applyAlignment(e.target.value)}))})),document.querySelectorAll('input[name="previewAlignment"]').forEach((e=>{e.addEventListener("change",(e=>{applyPreviewAlignment(e.target.value)}))})),applyAlignment(document.querySelector('input[name="alignment"]:checked').value),applyPreviewAlignment(document.querySelector('input[name="previewAlignment"]:checked').value),document.addEventListener("change",(function(e){if("music-mode"===e.target.name){const t=musicOptions.find((t=>t.id===e.target.value));t&&(loadVideo(t.url),offset=t.offset,document.getElementById("offsetDisplay").innerText=`${offset.toFixed(2)}초`)}}))}));
